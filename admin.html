<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minecraft Server Manager - Admin</title>

<style>
body {
    margin: 0;
    background: #0b0b0b;
    font-family: Consolas, monospace;
    color: #00ff9c;
}

.header {
    background: #111;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    border-bottom: 2px solid #00ff9c;
}

.status-panel {
    display: flex;
    justify-content: space-around;
    background: #111;
    padding: 10px;
    border-bottom: 2px solid #00ff9c;
}

.status-box {
    text-align: center;
}

.player-names {
    margin-top: 6px;
    font-size: 12px;
    color: #8cffd0;
    max-width: 220px;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    line-height: 1.3;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
}

.player-chip {
    background: rgba(0, 255, 156, 0.12);
    border: 1px solid rgba(0, 255, 156, 0.45);
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 12px;
    color: #b8ffe4;
}

.player-empty {
    opacity: 0.8;
}

.ram-bar {
    width: 200px;
    height: 12px;
    background: #222;
    border-radius: 6px;
    margin-top: 5px;
    overflow: hidden;
}

.ram-fill {
    height: 100%;
    width: 0%;
    background: #00ff9c;
    transition: 0.5s;
}

.console {
    height: calc(100vh - 340px);
    padding: 15px;
    overflow-y: auto;
    background: #000;
}

.input-area {
    display: flex;
    border-top: 2px solid #00ff9c;
    background: #111;
}

.input-area span {
    padding: 12px;
}

.input-area input {
    flex: 1;
    background: #111;
    border: none;
    color: #00ff9c;
    padding: 12px;
    font-size: 16px;
    outline: none;
}

.controls {
    background: #111;
    text-align: center;
    padding: 10px;
}

button {
    background: #00ff9c;
    border: none;
    padding: 8px 15px;
    margin: 5px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 6px;
}

button:hover {
    background: #00cc7a;
}

.admin-panel {
    background: #111;
    padding: 15px;
    border-bottom: 2px solid #00ff9c;
}

.admin-row {
    margin-bottom: 10px;
}

input[type="time"] {
    background: #1a1a1a;
    color: #00ff9c;
    border: none;
    padding: 5px;
}
</style>
</head>
<body>

<div class="header">
    Minecraft Server Manager - ADMIN PANEL
</div>

<div class="status-panel">
    <div class="status-box">
        <div>Players Online</div>
        <div id="playerCount">0 / 20</div>
        <div id="playerNames" class="player-names">None</div>
    </div>

    <div class="status-box">
        <div>RAM Usage</div>
        <div id="ramText">0MB / 4096MB</div>
        <div class="ram-bar">
            <div id="ramFill" class="ram-fill"></div>
        </div>
    </div>

    <div class="status-box">
        <div>PC Status</div>
        <div id="pcStatus">ONLINE</div>
    </div>

    <div class="status-box">
        <div>Server Status</div>
        <div id="serverStatus">OFFLINE</div>
    </div>

    <div class="status-box">
        <div>Current Time</div>
        <div id="currentTime"></div>
    </div>
</div>

<div class="admin-panel">
    <div class="admin-row">
        Schedule Maintenance Until:
        <input type="time" id="scheduleTime">
        <button onclick="setSchedule()">Set</button>
        <span id="scheduleInfo"></span>
    </div>

    <div class="admin-row">
        User Command Permission:
        <button id="commandApproveBtn" onclick="toggleCommandApprove()">Loading...</button>
        <span id="commandApproveInfo"></span>
    </div>
</div>

<div id="console" class="console">
[Admin] Control panel ready.<br>
</div>

<div class="input-area">
    <span>&gt;</span>
    <input id="cmdInput" type="text" placeholder="Enter command..." onkeydown="handleCommand(event)">
</div>

<div class="controls">
    <button onclick="startServer()">Start Server</button>
    <button onclick="stopServer()">Stop Server</button>
    <button onclick="clearConsole()">Clear</button>
    <button onclick="logout()">Logout</button>
</div>

<script>
if (sessionStorage.getItem("role") !== "admin") {
    window.location.href = "index.html";
}

const API_BASE = "https://mc-api-o0jz.onrender.com/v1";

const consoleBox = document.getElementById("console");
const playerCount = document.getElementById("playerCount");
const playerNames = document.getElementById("playerNames");
const ramText = document.getElementById("ramText");
const ramFill = document.getElementById("ramFill");
const pcStatus = document.getElementById("pcStatus");
const serverStatus = document.getElementById("serverStatus");
const currentTime = document.getElementById("currentTime");
const scheduleInput = document.getElementById("scheduleTime");
const scheduleInfo = document.getElementById("scheduleInfo");
const commandApproveBtn = document.getElementById("commandApproveBtn");
const commandApproveInfo = document.getElementById("commandApproveInfo");

let scheduledTime = null;
let consoleOffset = 0;
let commandApprove = true;

function print(text) {
    consoleBox.innerHTML += escapeHtml(text) + "<br>";
    consoleBox.scrollTop = consoleBox.scrollHeight;
}

function renderPlayerNames(players) {
    playerNames.innerHTML = "";
    if (!players || players.length === 0) {
        const empty = document.createElement("span");
        empty.className = "player-empty";
        empty.textContent = "No players";
        playerNames.appendChild(empty);
        return;
    }

    players.forEach(name => {
        const cleaned = cleanPlayerName(name);
        if (!cleaned) return;
        const chip = document.createElement("span");
        chip.className = "player-chip";
        chip.textContent = cleaned;
        playerNames.appendChild(chip);
    });
}

function cleanPlayerName(name) {
    let s = String(name || "").trim();
    s = s.replace(/ยง./g, "");
    s = s.replace(/&[0-9A-FK-ORa-fk-or]/g, "");
    s = s.replace(/\?{1,2}[0-9A-FK-ORa-fk-or]/g, "");
    const m = s.match(/[A-Za-z0-9_]{1,16}/);
    return m ? m[0] : "";
}

function escapeHtml(text) {
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

function toLocalTimeText(hhmm) {
    if (typeof hhmm !== "string" || !/^\d{2}:\d{2}$/.test(hhmm.trim())) return hhmm || "";
    const [hh, mm] = hhmm.split(":").map(Number);
    const now = new Date();
    const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    return dt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

async function apiRequest(path, options = {}) {
    const fetchOptions = { cache: "no-store", ...options };
    const separator = path.includes("?") ? "&" : "?";
    const res = await fetch(`${API_BASE}${path}${separator}_t=${Date.now()}`, fetchOptions);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.status === 204 ? {} : res.json();
}

function renderCommandApprove() {
    commandApproveBtn.innerText = commandApprove ? "TURN OFF USER COMMANDS" : "TURN ON USER COMMANDS";
    commandApproveInfo.innerText = commandApprove ? "User commands: ALLOWED" : "User commands: BLOCKED";
}

async function syncAdminSettings() {
    try {
        const data = await apiRequest("/rules");
        const rules = data.rules || {};
        commandApprove = rules.commandApprove !== false;
        renderCommandApprove();

        const dbTime = (rules.maintenanceUntil || "").toString();
        if (typeof dbTime === "string" && dbTime.trim()) {
            scheduledTime = dbTime.trim();
            scheduleInput.value = scheduledTime;
            scheduleInfo.innerText = `Maintenance until ${toLocalTimeText(scheduledTime)}`;
        } else {
            scheduledTime = null;
            scheduleInput.value = "";
            scheduleInfo.innerText = "";
        }
    } catch {
        commandApproveInfo.innerText = "Firebase sync failed";
    }
}

async function toggleCommandApprove() {
    try {
        commandApprove = !commandApprove;
        await apiRequest("/rules", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ commandApprove })
        });
        renderCommandApprove();
        print(`[Admin] command_approve set to ${commandApprove}`);
    } catch {
        print("[Error] Failed to update command_approve.");
    }
}

async function setSchedule() {
    const value = scheduleInput.value.trim();
    try {
        await apiRequest("/rules", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ maintenanceUntil: value || "" })
        });
        scheduledTime = value || null;
        const localText = toLocalTimeText(value);
        scheduleInfo.innerText = value ? `Maintenance until ${localText}` : "Maintenance cleared";
        print(value ? `[Admin] Maintenance set until ${localText}` : "[Admin] Maintenance cleared");
    } catch {
        print("[Error] Failed to update maintenance time.");
    }
}

function applyStatus(status) {
    const maxPlayers = Number(status.maxPlayers || 0);
    const online = Number(status.onlinePlayers || 0);
    const ram = Number(status.ramUsageMb || 0);
    const players = Array.isArray(status.players) ? status.players : [];
    const ramMax = 8192;

    playerCount.innerText = `${online} / ${maxPlayers || 0}`;
    renderPlayerNames(players);
    ramText.innerText = `${ram}MB / ${ramMax}MB`;
    ramFill.style.width = `${Math.min(100, Math.round((ram / ramMax) * 100))}%`;

    pcStatus.innerText = "ONLINE";
    pcStatus.style.color = "#00ff9c";

    if (status.isRunning) {
        serverStatus.innerText = "RUNNING";
        serverStatus.style.color = "#00ff9c";
    } else {
        serverStatus.innerText = "STOPPED";
        serverStatus.style.color = "red";
    }
}

async function refreshStatus() {
    try {
        const data = await apiRequest("/status");
        const status = data.status || {};
        applyStatus(status);
    } catch {
        pcStatus.innerText = "OFFLINE";
        pcStatus.style.color = "red";
        serverStatus.innerText = "UNKNOWN";
        serverStatus.style.color = "#ffcc66";
    }
}

async function pollConsole() {
    try {
        const data = await apiRequest(`/console?since=${consoleOffset}`);
        if (data && data.ok && Array.isArray(data.lines)) {
            data.lines.forEach(item => print(item.text || ""));
        }
        if (data && typeof data.next === "number") {
            consoleOffset = data.next;
        }
    } catch {
        // silent
    }
}

function updateClock() {
    currentTime.innerText = new Date().toLocaleTimeString();
}

async function handleCommand(e) {
    if (e.key !== "Enter") return;
    const cmd = e.target.value.trim();
    if (!cmd) return;

    print(`> ${cmd}`);
    e.target.value = "";

    try {
        const data = await apiRequest("/commands", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role: "admin", requestedBy: "admin", command: cmd })
        });
        print(data.ok ? `[Queue] Command queued: ${cmd}` : "[Error] Failed to queue command.");
    } catch {
        print("[Error] Failed to send command.");
    }
}

async function startServer() {
    try {
        const data = await apiRequest("/commands", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role: "admin", requestedBy: "admin", command: "start_server" })
        });
        print(data.ok ? "[Queue] Start command queued." : "[Error] Server start queue failed.");
    } catch {
        print("[Error] Failed to contact local API.");
    }
}

async function stopServer() {
    try {
        const data = await apiRequest("/commands", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role: "admin", requestedBy: "admin", command: "stop_server" })
        });
        print(data.ok ? "[Queue] Stop command queued." : "[Error] Server stop queue failed.");
    } catch {
        print("[Error] Failed to contact local API.");
    }
}

function clearConsole() {
    consoleBox.innerHTML = "";
}

function logout() {
    sessionStorage.removeItem("role");
    sessionStorage.removeItem("username");
    window.location.href = "index.html";
}

refreshStatus();
pollConsole();
syncAdminSettings();
updateClock();
setInterval(refreshStatus, 1000);
setInterval(pollConsole, 1000);
setInterval(syncAdminSettings, 5000);
setInterval(updateClock, 1000);
window.addEventListener("focus", () => {
    refreshStatus();
    pollConsole();
    syncAdminSettings();
});
</script>

</body>
</html>
