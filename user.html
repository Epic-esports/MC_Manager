<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Minecraft Server Console</title>

<style>
body {
    margin: 0;
    background: #0b0b0b;
    font-family: Consolas, monospace;
    color: #00ff9c;
}

.header {
    background: #111;
    padding: 15px;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    border-bottom: 2px solid #00ff9c;
}

.status-panel {
    display: flex;
    justify-content: space-around;
    background: #111;
    padding: 10px;
    border-bottom: 2px solid #00ff9c;
}

.status-box {
    text-align: center;
}

.player-names {
    margin-top: 6px;
    font-size: 12px;
    color: #8cffd0;
    max-width: 220px;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    line-height: 1.3;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
}

.player-chip {
    background: rgba(0, 255, 156, 0.12);
    border: 1px solid rgba(0, 255, 156, 0.45);
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 12px;
    color: #b8ffe4;
}

.player-empty {
    opacity: 0.8;
}

.ram-bar {
    width: 200px;
    height: 12px;
    background: #222;
    border-radius: 6px;
    margin-top: 5px;
    overflow: hidden;
}

.ram-fill {
    height: 100%;
    width: 0%;
    background: #00ff9c;
    transition: 0.5s;
}

.console {
    height: calc(100vh - 240px);
    padding: 15px;
    overflow-y: auto;
    background: #000;
}

.input-area {
    display: flex;
    border-top: 2px solid #00ff9c;
    background: #111;
}

.input-area span {
    padding: 12px;
}

.input-area input {
    flex: 1;
    background: #111;
    border: none;
    color: #00ff9c;
    padding: 12px;
    font-size: 16px;
    outline: none;
}

.controls {
    background: #111;
    text-align: center;
    padding: 10px;
}

button {
    background: #00ff9c;
    border: none;
    padding: 8px 15px;
    margin: 5px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 6px;
}

button:hover {
    background: #00cc7a;
}

#maintenanceOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.86);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    z-index: 9999;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.25s ease;
}

#maintenanceOverlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

#maintenanceCard {
    background: #141414;
    border: 2px solid #00ff9c;
    border-radius: 14px;
    max-width: 420px;
    width: 100%;
    padding: 22px 18px;
    box-shadow: 0 0 30px rgba(0, 255, 156, 0.3);
    transform: scale(0.92);
    opacity: 0;
}

#maintenanceOverlay.active #maintenanceCard {
    animation: popupIn 0.28s ease forwards;
}

@keyframes popupIn {
    from { transform: scale(0.92); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}
</style>
</head>
<body>

<div class="header">
    Minecraft Server Manager - USER PANEL
</div>

<div class="status-panel">
    <div class="status-box">
        <div>Players Online</div>
        <div id="playerCount">0 / 20</div>
        <div id="playerNames" class="player-names">None</div>
    </div>

    <div class="status-box">
        <div>RAM Usage</div>
        <div id="ramText">0MB / 2048MB</div>
        <div class="ram-bar">
            <div id="ramFill" class="ram-fill"></div>
        </div>
    </div>

    <div class="status-box">
        <div>PC Status</div>
        <div id="pcStatus" style="color:red;">OFFLINE</div>
        <div style="margin-top:6px;">Server Status</div>
        <div id="serverStatus" style="color:red;">STOPPED</div>
        <button onclick="turnOnPC()">Turn ON</button>
    </div>
</div>

<div id="console" class="console">
[User] Console ready.<br>
</div>

<div class="input-area">
    <span>&gt;</span>
    <input id="cmdInput" type="text" placeholder="Enter command..." onkeydown="handleCommand(event)">
</div>

<div class="controls">
    <button id="startBtn" onclick="startServer()">Start Server</button>
    <button onclick="clearConsole()">Clear</button>
    <button onclick="logout()">Logout</button>
</div>

<div id="maintenanceOverlay">
    <div id="maintenanceCard">
        <h2>Server Under Maintenance</h2>
        <p id="maintenanceText">Please wait.</p>
    </div>
</div>

<script>
if (sessionStorage.getItem("role") !== "user") {
    window.location.href = "index.html";
}

const API_BASE = "https://mc-api-o0jz.onrender.com/v1";

const consoleBox = document.getElementById("console");
const playerCount = document.getElementById("playerCount");
const playerNames = document.getElementById("playerNames");
const ramText = document.getElementById("ramText");
const ramFill = document.getElementById("ramFill");
const pcStatus = document.getElementById("pcStatus");
const serverStatus = document.getElementById("serverStatus");
const cmdInput = document.getElementById("cmdInput");
const startBtn = document.getElementById("startBtn");
const maintenanceOverlay = document.getElementById("maintenanceOverlay");
const maintenanceText = document.getElementById("maintenanceText");

let consoleOffset = 0;
let userCommandAllowed = true;
let maintenanceActive = false;

function print(text) {
    consoleBox.innerHTML += escapeHtml(text) + "<br>";
    consoleBox.scrollTop = consoleBox.scrollHeight;
}

function renderPlayerNames(players) {
    playerNames.innerHTML = "";
    if (!players || players.length === 0) {
        const empty = document.createElement("span");
        empty.className = "player-empty";
        empty.textContent = "No players";
        playerNames.appendChild(empty);
        return;
    }

    players.forEach(name => {
        const cleaned = cleanPlayerName(name);
        if (!cleaned) return;
        const chip = document.createElement("span");
        chip.className = "player-chip";
        chip.textContent = cleaned;
        playerNames.appendChild(chip);
    });
}

function cleanPlayerName(name) {
    let s = String(name || "").trim();
    s = s.replace(/ยง./g, "");
    s = s.replace(/&[0-9A-FK-ORa-fk-or]/g, "");
    s = s.replace(/\?{1,2}[0-9A-FK-ORa-fk-or]/g, "");
    const m = s.match(/[A-Za-z0-9_]{1,16}/);
    return m ? m[0] : "";
}

function escapeHtml(text) {
    return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

function toLocalTimeText(hhmm) {
    if (typeof hhmm !== "string" || !/^\d{2}:\d{2}$/.test(hhmm.trim())) return hhmm || "";
    const [hh, mm] = hhmm.split(":").map(Number);
    const now = new Date();
    const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    return dt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

async function apiRequest(path, options = {}) {
    const fetchOptions = { cache: "no-store", ...options };
    const separator = path.includes("?") ? "&" : "?";
    const res = await fetch(`${API_BASE}${path}${separator}_t=${Date.now()}`, fetchOptions);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.status === 204 ? {} : res.json();
}

function parseScheduleTime(value) {
    if (typeof value !== "string" || !/^\d{2}:\d{2}$/.test(value.trim())) {
        return null;
    }

    const [hh, mm] = value.split(":").map(Number);
    const now = new Date();
    const scheduled = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    return scheduled;
}

function applyRestrictions() {
    const blocked = maintenanceActive || !userCommandAllowed;
    cmdInput.disabled = blocked;

    if (maintenanceActive) {
        startBtn.disabled = true;
        maintenanceOverlay.classList.add("active");
    } else {
        startBtn.disabled = false;
        maintenanceOverlay.classList.remove("active");
    }
}

async function refreshUserRules() {
    try {
        const data = await apiRequest("/rules");
        const rules = data.rules || {};
        userCommandAllowed = rules.commandApprove !== false;

        const timeSidul = (rules.maintenanceUntil || "").toString();
        const schedule = parseScheduleTime(timeSidul);
        const now = new Date();

        if (schedule && now < schedule) {
            maintenanceActive = true;
            const openAfter = toLocalTimeText(timeSidul);
            maintenanceText.innerText = `Server is under maintenance. Open after ${openAfter}.`;
        } else {
            maintenanceActive = false;
        }

        applyRestrictions();
    } catch {
        // keep last rule state
    }
}

function applyStatus(status) {
    const maxPlayers = Number(status.maxPlayers || 0);
    const online = Number(status.onlinePlayers || 0);
    const ram = Number(status.ramUsageMb || 0);
    const players = Array.isArray(status.players) ? status.players : [];
    const ramMax = 8192;

    playerCount.innerText = `${online} / ${maxPlayers || 0}`;
    renderPlayerNames(players);
    ramText.innerText = `${ram}MB / ${ramMax}MB`;
    ramFill.style.width = `${Math.min(100, Math.round((ram / ramMax) * 100))}%`;

    pcStatus.innerText = "ONLINE";
    pcStatus.style.color = "#00ff9c";

    if (status.isRunning) {
        serverStatus.innerText = "RUNNING";
        serverStatus.style.color = "#00ff9c";
    } else {
        serverStatus.innerText = "STOPPED";
        serverStatus.style.color = "red";
    }
}

async function refreshStatus() {
    try {
        const data = await apiRequest("/status");
        const status = data.status || {};
        applyStatus(status);
    } catch {
        pcStatus.innerText = "OFFLINE";
        pcStatus.style.color = "red";
        serverStatus.innerText = "UNKNOWN";
        serverStatus.style.color = "#ffcc66";
    }
}

async function pollConsole() {
    try {
        const data = await apiRequest(`/console?since=${consoleOffset}`);
        if (data && data.ok && Array.isArray(data.lines)) {
            data.lines.forEach(item => print(item.text || ""));
        }
        if (data && typeof data.next === "number") {
            consoleOffset = data.next;
        }
    } catch {
        // silent
    }
}

function turnOnPC() {
    refreshStatus();
    print("[System] Refreshing connection to local server API...");
}

async function handleCommand(e) {
    if (e.key !== "Enter") return;

    const input = e.target.value.trim();
    if (!input) return;

    if (maintenanceActive) {
        print("[Blocked] Server is under maintenance.");
        e.target.value = "";
        return;
    }

    if (!userCommandAllowed) {
        print("[Blocked] Admin disabled user command access.");
        e.target.value = "";
        return;
    }

    print(`> ${input}`);
    e.target.value = "";

    try {
        const data = await apiRequest("/commands", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role: "user", requestedBy: sessionStorage.getItem("username") || "user", command: input })
        });
        if (!data.ok) {
            print(`[Blocked] ${data.error || "Command is not allowed."}`);
            return;
        }
        print("[Queue] Command queued.");
    } catch {
        print("[Error] Command failed.");
    }
}

async function startServer() {
    if (maintenanceActive) {
        print("[Blocked] Server is under maintenance.");
        return;
    }

    try {
        const data = await apiRequest("/commands", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role: "user", requestedBy: sessionStorage.getItem("username") || "user", command: "start_server" })
        });
        if (!data.ok) {
            print(`[Blocked] ${data.error || "Start not allowed."}`);
            return;
        }
        print("[Queue] Start request queued.");
    } catch {
        print("[Error] Failed to contact cloud API.");
    }
}

function clearConsole() {
    consoleBox.innerHTML = "";
}

function logout() {
    sessionStorage.removeItem("role");
    sessionStorage.removeItem("username");
    window.location.href = "index.html";
}

refreshStatus();
pollConsole();
refreshUserRules();
setInterval(refreshStatus, 1000);
setInterval(pollConsole, 1000);
setInterval(refreshUserRules, 3000);
window.addEventListener("focus", () => {
    refreshStatus();
    pollConsole();
    refreshUserRules();
});
</script>

</body>
</html>
